<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>Kaspi 电商利润计算器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #333;
            padding: 10px;
            min-height: 100vh;
            position: relative;
        }

        /* 倒计时样式 */
        #countdown {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            color: #d35400;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        
        #countdown .icon {
            margin-right: 8px;
            font-size: 18px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #ff8c00, #ffd700, #ff8c00);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            padding-bottom: 15px;
            padding-top: 40px;
        }

        .header h1 {
            font-size: 24px;
            color: #1a2a6c;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .header h2 {
            font-size: 18px;
            color: #d35400;
            font-weight: 600;
        }

        .header::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 3px;
            background: linear-gradient(90deg, #1a2a6c, #3498db, #1a2a6c);
            border-radius: 2px;
        }

        /* 修改汇率显示样式 */
        .exchange-rate {
            background-color: #e3f2fd;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #bbdefb;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center; /* 添加这行实现垂直居中 */
            gap: 8px;
        }

        .exchange-rate label {
            font-weight: bold;
            color: #0d47a1;
            font-size: 16px;
            white-space: nowrap;
            margin: 0; /* 添加这行消除可能的默认边距 */
        }

        .exchange-rate input {
            font-size: 16px;
            padding: 8px 12px;
            border: 2px solid #64b5f6;
            border-radius: 8px;
            width: 150px;
            text-align: center;
            color: #1565c0;
            font-weight: bold;
            background-color: #fff;
            margin: 0; /* 添加这行消除可能的默认边距 */
            vertical-align: middle; /* 添加这行确保输入框垂直对齐 */
        }

        .input-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .section {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 18px;
            color: #1a2a6c;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #3498db;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .form-control::placeholder {
            color: #aaa;
            font-style: italic;
        }

        .error-message {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 4px;
            display: none;
        }

        .dimensions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        /* 新增Kaspi售价双列样式 */
        .kaspi-price-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .kaspi-price-box {
            display: flex;
            flex-direction: column;
        }

        .kaspi-price-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 4px;
        }

        .output-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .output-group {
            background-color: #e8f5e9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #c8e6c9;
        }

        .output-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2e7d32;
            font-size: 14px;
        }

        .output-value {
            font-size: 16px;
            font-weight: bold;
            color: #1b5e20;
            background-color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #a5d6a7;
            text-align: right;
        }

        .results-section {
            background-color: #fffde7;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #ffe082;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .result-item {
            padding: 12px;
            border-radius: 8px;
            background-color: #fff9c4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-item.final {
            background-color: #ffecb3;
            padding: 16px;
            font-weight: bold;
        }

        .result-label {
            font-weight: 600;
            color: #5d4037;
            font-size: 15px;
        }

        .result-value {
            font-size: 18px;
            font-weight: bold;
            color: #e65100;
            min-width: 100px;
            text-align: right;
        }

        .btn-calculate {
            display: block;
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn-calculate:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-calculate:active {
            transform: translateY(1px);
        }

        .footer {
            text-align: center;
            margin-top: 15px;
            color: #7f8c8d;
            font-size: 13px;
            padding-top: 12px;
            border-top: 1px solid #ecf0f1;
        }

        .category-container {
            position: relative;
        }

        .category-levels {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .category-search {
            position: relative;
        }

        .category-search input {
            padding-right: 40px;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #7f8c8d;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }

        .search-result-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .search-result-item:hover {
            background-color: #f0f8ff;
        }

        .language-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .lang-btn {
            background: #1a2a6c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 13px;
        }

        .lang-btn.active {
            background: #ff8c00;
            transform: scale(1.05);
        }

        .currency-selector {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .currency-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .currency-radio {
            margin-right: 6px;
        }

        .currency-label {
            font-weight: 500;
            font-size: 14px;
        }

        /* 开关样式 */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 5px;
            padding: 8px 0;
            border-top: 1px dashed #e0e0e0;
        }

        .switch-label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(23px);
        }

        /* 费用单价容器样式 */
        .cost-price-container {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 8px;
            margin-top: 12px;
            background: #f5f9ff; 
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e3f2fd;
        }

        .cost-price-group {
            background: #fff; 
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #bbdefb;
            transition: all 0.3s ease;
        }

        .cost-price-group:hover {
            border-color: #64b5f6;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .cost-price-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #1976d2;
            font-weight: 500;
        }

        .cost-price-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e3f2fd;
            border-radius: 6px;
            font-size: 14px;
            color: #0d47a1;
            background: #fff;
            transition: all 0.3s ease;
        }

        .cost-price-group input:focus {
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            outline: none;
        }

        /* 新增样式 */
        .commission-display {
            margin-top: 5px;
            font-size: 13px;
            color: #3498db;
            font-weight: 500;
        }

        /* 俄语界面样式 */
        .lang-ru .purchase-label::after,
        .lang-ru .shipping-label::after,
        .lang-ru .gross-profit-label::after {
            content: " (₸)";
        }

        .lang-zh .gross-profit-label::after {
            content: " (¥)";
        }

        .lang-ru .form-control::placeholder {
            font-style: normal;
        }

        .toggle-off {
            color: #e74c3c;
            font-weight: bold;
        }

        /* 移动端优化 */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .header h2 {
                font-size: 16px;
            }
            
            .exchange-rate {
                flex-direction: row; /* 修改为横向排列 */
                align-items: center;
                padding: 8px 12px;
            }
            
            .exchange-rate label {
                font-size: 14px;
            }
            
            .exchange-rate input {
                width: 100px; /* 调整移动端输入框宽度 */
                padding: 6px 8px;
                font-size: 14px;
            }
            
            .dimensions {
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            .section {
                padding: 12px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .btn-calculate {
                padding: 12px;
                font-size: 16px;
                margin: 15px 0;
            }
            
            .result-label, .result-value {
                font-size: 14px;
            }
            
            .result-value {
                min-width: 80px;
                font-size: 16px;
            }
            
            .currency-selector {
                flex-direction: column;
                gap: 8px;
            }
            
            .language-switcher {
                top: 5px;
                right: 5px;
            }
            
            .lang-btn {
                padding: 5px 10px;
                font-size: 12px;
            }
            
            .results-section {
                padding: 15px;
            }
            
            .kaspi-price-container {
                grid-template-columns: 1fr;
            }
            
            #countdown {
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        /* 平板优化 */
        @media (min-width: 481px) and (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }
            
            .output-section {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .header {
                padding-top: 30px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .header h2 {
                font-size: 17px;
            }
            
            .dimensions {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 10px;
            }
        }

        /* 桌面优化 */
        @media (min-width: 769px) {
            .input-section {
                grid-template-columns: 1fr 1fr;
            }
            
            .output-section {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* 避免移动端键盘弹出时遮挡输入框 */
        @media (max-height: 600px) and (orientation: landscape) {
            .container {
                max-height: 95vh;
                overflow-y: auto;
            }
        }


        .history-section {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .history-section h3 {
            font-size: 18px;
            color: #1a2a6c;
            margin-bottom: 15px;
            padding-bottom: 6px;
            border-bottom: 2px solid #3498db;
            font-weight: 600;
        }

        .history-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 15px;
        }

        .history-btn {
            padding: 8px 16px;
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .history-table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #historyTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        #historyTable th {
            background-color: #1a2a6c;
            color: white;
            padding: 10px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #historyTable td {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
        }

        #historyTable tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #historyTable tr:hover {
            background-color: #e3f2fd;
        }

        #historyTable .delete-btn {
            padding: 5px 10px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #historyTable .delete-btn:hover {
            background-color: #c0392b;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .history-table-container {
                font-size: 12px;
            }
            
            #historyTable th, 
            #historyTable td {
                padding: 6px 8px;
            }
            
            .history-actions {
                flex-direction: column;
                align-items: flex-end;
            }
        }
        /* 免责声明样式 */
        .disclaimer-section {
            background-color: #fff3e0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #ffcc80;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .disclaimer-section h3 {
            color: #e65100;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 6px;
            border-bottom: 2px solid #ff9800;
        }

        .disclaimer-content p {
            font-size: 14px;
            color: #5d4037;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        /* 广告区域样式 */
        .advertisement-section {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            color: white;
        }

        .ad-title {
            text-align: center;
            color: white !important;
        }

        .ad-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .ad-item {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ad-item:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* 俄语界面隐藏广告项 */
        .lang-ru .ad-grid {
            display: none;
        }

        /* 联系方式样式 */
        .contact-section {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }

        .contact-info {
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 500;
        }

        #contact-link {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        #contact-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        #modalBody {
            text-align: center;
            font-size: 18px;
            line-height: 1.6;
        }

        #modalBody img {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .ad-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .modal-content {
                width: 90%;
                margin: 20% auto;
            }
        }
    </style>
</head>
<body>
<div id="countdown">
    <span class="icon">⏳</span>
    <span id="countdown-text">服务截止: --:--:--</span>
</div>

<div class="container">
    <div class="header">
        <h1 id="company-name">新疆航贸通国际供应链有限公司</h1>
        <h2 id="app-title">Kaspi 电商利润计算器</h2>
        <div class="language-switcher">
            <button class="lang-btn active" data-lang="zh">中文</button>
            <button class="lang-btn" data-lang="ru">Русский</button>
        </div>
    </div>
    <div class="exchange-rate">
        <label id="exchange-label">当前汇率：1元人民币兑换</label>
        <input id="exchangeRate" min="0" placeholder="输入汇率" step="0.01" type="number" value="70"/>
        <label id="currency-label">哈萨克斯坦坚戈</label>
        <div class="error-message" id="exchange-error">汇率必须大于0</div>
    </div>
    <div class="input-section">
        <div class="section">
            <h3 class="section-title" id="product-info-title">产品信息</h3>
            <div class="form-group category-container">
                <label for="category-search" id="category-label">商品分类</label>
                <div class="category-search">
                    <input autocomplete="off" class="form-control" id="category-search" placeholder="搜索分类..." type="text"/>
                    <span class="search-icon">🔍</span>
                    <div class="search-results" id="search-results"></div>
                </div>
                <select class="form-control" id="category-select">
                    <option data-commission="" value="">-- 请选择商品分类 --</option>
                </select>
                <div class="commission-display" id="commission-display">当前佣金率：0%</div>
            </div>
            <div class="form-group">
                <label for="purchasePrice" id="purchase-label">采购价 (¥)</label>
                <input class="form-control" id="purchasePrice" min="0" placeholder="输入采购价" step="0.01" type="number" value=""/>
                <div class="error-message" id="purchase-error">请输入有效的采购价</div>
            </div>
            <div class="form-group">
                <label for="shippingCost" id="shipping-label">运费 (¥)</label>
                <input class="form-control" id="shippingCost" min="0" placeholder="阿拉木图运费" step="0.01" type="number" value=""/>
                <div class="error-message" id="shipping-error">请输入有效的运费</div>
            </div>
            <div class="form-group">
                <label for="grossProfit" id="gross-profit-label">计划毛利 (¥)</label>
                <input class="form-control" id="grossProfit" min="0" placeholder="输入计划毛利" step="0.01" type="number" value=""/>
                <div class="error-message" id="profit-error">请输入有效的计划毛利</div>
            </div>
            <div class="form-group">
                <label id="cashback-label">下单返利（%）</label>
                <input class="form-control" id="cashback" min="0" placeholder="输入下单返利" step="0.1" type="number" value=""/>
            </div>
            <div class="form-group">
                <label for="paymentMethod" id="payment-label">汇款方式</label>
                <select class="form-control" id="paymentMethod">
                    <option value="publicToPublic">银行公对公</option>
                    <option value="publicToPrivate">银行公对私</option>
                    <option value="privateToPrivate">银行私对私</option>
                    <option value="wechat">微信</option>
                    <option value="alipay">支付宝</option>
                    <option value="kaspi">Kaspi.kz</option>
                </select>
            </div>
        </div>
        <div class="section">
            <h3 class="section-title" id="logistics-title">物流信息</h3>
            <div class="form-group">
                <label id="dimension-label">尺寸（厘米）</label>
                <div class="dimensions">
                    <div>
                        <input class="form-control" id="length" min="0.1" placeholder="长" step="0.1" type="number" value=""/>
                    </div>
                    <div>
                        <input class="form-control" id="width" min="0.1" placeholder="宽" step="0.1" type="number" value=""/>
                    </div>
                    <div>
                        <input class="form-control" id="height" min="0.1" placeholder="高" step="0.1" type="number" value=""/>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="volume" id="volume-label">体积（立方米）</label>
                <input class="form-control output-value" id="volume" readonly="" type="text"/>
            </div>
            <div class="form-group">
                <label for="weight" id="weight-label">重量（千克）</label>
                <input class="form-control" id="weight" min="0.01" placeholder="输入重量" step="0.01" type="number" value=""/>
                <div class="error-message" id="weight-error">请输入有效的重量</div>
            </div>
            <div class="form-group">
                <label id="kaspi-price-label">Kaspi 售价</label>
                <div class="kaspi-price-container">
                    <div class="kaspi-price-box">
                        <div class="kaspi-price-label" id="kaspi-price-cny-label">人民币 (¥)</div>
                        <input class="form-control output-value" id="kaspiPriceCny" readonly="" type="text"/>
                    </div>
                    <div class="kaspi-price-box">
                        <div class="kaspi-price-label" id="kaspi-price-kzt-label">坚戈 (₸)</div>
                        <input class="form-control output-value" id="kaspiPriceKzt" readonly="" type="text"/>
                    </div>
                </div>
            </div>
            <div class="cost-price-container">
                <div class="cost-price-group">
                    <label id="overseas-unit-label">海外仓单价 (¥/m³)</label>
                    <input id="overseasUnitPrice" min="0" step="1" type="number" value="1000"/>
                </div>
                <div class="cost-price-group">
                    <label id="firstmile-unit-label">头程单价 (¥/m³)</label>
                    <input id="firstMileUnitPrice" min="0" step="1" type="number" value="100"/>
                </div>
            </div>
        </div>
    </div>
    <button class="btn-calculate" data-ru="Рассчитать прибыль" data-zh="计算利润" id="calculateBtn">计算利润</button>
    
    <!-- 增值服务和业务咨询移动到计算按钮下方 -->
    <div class="advertisement-section">
        <h3 class="section-title ad-title" id="ad-title">增值服务</h3>
        <div class="ad-grid">
            <div class="ad-item">海外仓服务</div>
            <div class="ad-item">Kaspi头程物流</div>
            <div class="ad-item">Kaspi电商入驻</div>
            <div class="ad-item">中亚国际物流</div>
            <div class="ad-item">签证代办服务</div>
            <div class="ad-item">车辆出境手续</div>
            <div class="ad-item">海外公司注册</div>
            <div class="ad-item">中亚海外仓</div>
            <div class="ad-item">产品电商代售</div>
        </div>
    </div>
    
    <div class="contact-section">
        <div class="contact-info" id="contact-info">
            <span>业务咨询：</span>
            <a href="#" id="contact-link">点击联系客服</a>
        </div>
    </div>
    
    <div class="output-section">
        <div class="section">
            <h3 class="section-title" id="fees-title">头程、海外仓费用</h3>
            <div class="switch-container">
                <span class="switch-label" id="overseas-toggle-label">是否计算海外仓费用</span>
                <label class="switch">
                    <input checked="" id="overseasToggle" type="checkbox"/>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="output-group">
                <label id="overseas-label">海外仓费用</label>
                <input class="form-control output-value" id="overseasWarehouse" readonly="" type="text">
            </div>
            <div class="switch-container">
                <span class="switch-label" id="firstmile-toggle-label">是否计算头程费用</span>
                <label class="switch">
                    <input checked="" id="firstMileToggle" type="checkbox"/>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="output-group">
                <label id="firstmile-label">头程费用</label>
                <input class="form-control output-value" id="firstMile" readonly="" type="text">
            </div>
        </div>
        <div class="section">
            <h3 class="section-title" id="platform-title">平台费用</h3>
            <div class="output-group">
                <label id="cashback-amount-label">下单返利</label>
                <input class="form-control output-value" id="cashbackAmount" readonly="" type="text">
            </div>
            <div class="output-group">
                <label id="kaspi-shipping-label">Kaspi 运费</label>
                <input class="form-control output-value" id="kaspiShipping" readonly="" type="text">
            </div>
            <div class="output-group">
                <label id="platform-fee-label">平台佣金</label>
                <input class="form-control output-value" id="platformFee" readonly="" type="text"/>
            </div>
            <div class="output-group">
                <label id="withdrawal-tax-label">提现税（4%）</label>
                <input class="form-control output-value" id="withdrawalTax" readonly="" type="text"/>
            </div>
        </div>
    </div>
    <div class="results-section">
        <h3 class="section-title" id="return-title">回款费用</h3>
        <div class="switch-container">
            <span class="switch-label" id="withdrawal-fee-toggle-label">是否计算提现手续费</span>
            <label class="switch">
                <input checked="" id="withdrawalFeeToggle" type="checkbox"/>
                <span class="slider"></span>
            </label>
        </div>
        <div class="output-group">
            <label id="withdrawal-fee-label">提现手续费（1%）</label>
            <input class="form-control output-value" id="withdrawalFee" readonly="" type="text">
        </div>
        <div class="switch-container">
            <span class="switch-label" id="exchange-loss-toggle-label">是否计算汇损</span>
            <label class="switch">
                <input checked="" id="exchangeLossToggle" type="checkbox"/>
                <span class="slider"></span>
            </label>
        </div>
        <div class="output-group">
            <label id="exchange-loss-label">汇损（1.42%）</label>
            <input class="form-control output-value" id="exchangeLoss" readonly="" type="text">
        </div>
        <div class="switch-container">
            <span class="switch-label" id="remittance-fee-toggle-label">是否计算汇款手续费</span>
            <label class="switch">
                <input checked="" id="remittanceFeeToggle" type="checkbox"/>
                <span class="slider"></span>
            </label>
        </div>
        <div class="output-group">
            <label id="remittance-fee-label">汇款手续费</label>
            <input class="form-control output-value" id="remittanceFee" readonly="" type="text">
        </div>
        <div class="results-grid">
            <div class="result-item">
                <div class="result-label" id="kaspi-pay-label">Kaspi pay提现到账金额</div>
                <div class="result-value" id="kaspiPayAmount">0.00</div>
            </div>
            <div class="result-item">
                <div class="result-label" id="return-amount-label">回款金额</div>
                <div class="result-value" id="returnAmountDisplay">0.00</div>
            </div>
            <div class="result-item">
                <div class="result-label" id="estimated-amount-label">预估到账金额</div>
                <div class="result-value" id="estimatedAmount">0.00</div>
            </div>
            <div class="result-item final">
                <div class="result-label" id="profit-label-final">利润</div>
                <div class="result-value" id="profit">0.00</div>
            </div>
        </div>
        <div class="currency-selector">
            <div class="currency-option">
                <input checked="" class="currency-radio" id="currency-cny" name="currency" type="radio" value="cny"/>
                <label class="currency-label" for="currency-cny" id="cny-label">人民币 (CNY)</label>
            </div>
            <div class="currency-option">
                <input class="currency-radio" id="currency-kzt" name="currency" type="radio" value="kzt"/>
                <label class="currency-label" for="currency-kzt" id="kzt-label">哈萨克斯坦坚戈 (KZT)</label>
            </div>
        </div>
    </div>
    
    <!-- 历史记录表格区域 -->
    <div class="history-section">
        <h3 class="section-title" id="history-title">历史记录</h3>
        <div class="history-actions">
            <button class="history-btn" id="exportHistoryBtn">导出为CSV</button>
            <button class="history-btn" id="clearHistoryBtn">清空历史</button>
        </div>
        <div class="history-table-container">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>商品分类</th>
                        <th>采购价</th>
                        <th>运费</th>
                        <th>计划毛利</th>
                        <th>下单返利(%)</th>
                        <th>汇款方式</th>
                        <th>尺寸(长宽高)</th>
                        <th>体积</th>
                        <th>重量</th>
                        <th>海外仓费用</th>
                        <th>头程费用</th>
                        <th>下单返利</th>
                        <th>Kaspi运费</th>
                        <th>平台佣金</th>
                        <th>提现税</th>
                        <th>提现手续费</th>
                        <th>汇损</th>
                        <th>汇款手续费</th>
                        <th>Kaspi提现</th>
                        <th>回款金额</th>
                        <th>预估到账</th>
                        <th>利润</th>
                        <th>币种</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- 历史记录将通过JS动态添加 -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 免责声明 - 添加多语言支持 -->
    <div class="disclaimer-section">
        <h3 class="section-title" id="disclaimer-title">免责声明</h3>
        <div class="disclaimer-content" id="disclaimer-content">
            <p>以上计算结果仅供参考，不代表最终费用。实际费用可能因市场变化、汇率波动、平台政策调整等因素而有所不同，请以实际情况为准。</p>
            <p>本计算器提供的数据仅作为商业决策的参考依据，不构成任何形式的承诺或保证。使用本工具产生的任何商业风险由使用者自行承担。</p>
        </div>
    </div>
    
    <div class="footer">
        <p id="copyright">© 2023 新疆航贸通国际供应链有限公司 | Kaspi 电商利润计算器</p>
    </div>
</div>

<!-- 联系弹窗 -->
<div id="contactModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalBody"></div>
    </div>
</div>

<script>
// translations.js
const translations = {
    zh: {
        companyName: "新疆航贸通国际供应链有限公司",
        appTitle: "Kaspi 电商利润计算器",
        exchangeLabel: "当前汇率：1元人民币兑换",
        currencyLabel: "哈萨克斯坦坚戈",
        productInfo: "产品信息",
        categoryLabel: "商品分类",
        purchaseLabel: "采购价 (¥)",
        shippingLabel: "运费 (¥)",
        grossProfitLabel: "计划毛利 (¥)",
        cashbackLabel: "下单返利（%）",
        paymentLabel: "汇款方式",
        logisticsTitle: "物流信息",
        dimensionLabel: "尺寸（厘米）",
        volumeLabel: "体积（立方米）",
        weightLabel: "重量（千克）",
        kaspiPriceLabel: "Kaspi 售价",
        feesTitle: "头程、海外仓费用",
        overseasLabel: "海外仓费用",
        firstmileLabel: "头程费用",
        platformTitle: "平台费用",
        cashbackAmountLabel: "下单返利",
        kaspiShippingLabel: "Kaspi 运费",
        platformFeeLabel: "平台佣金",
        withdrawalTaxLabel: "提现税（4%）",
        returnTitle: "回款费用",
        withdrawalFeeLabel: "提现手续费（1%）",
        exchangeLossLabel: "汇损（1.42%）",
        remittanceFeeLabel: "汇款手续费",
        returnAmountLabel: "回款金额",
        kaspiPayLabel: "Kaspi pay提现到账金额",
        estimatedAmountLabel: "预估到账金额",
        profitLabelFinal: "利润",
        copyright: "© 2023 新疆航贸通国际供应链有限公司 | Kaspi 电商利润计算器",
        calculateBtn: "计算利润",
        cnyLabel: "人民币 (CNY)",
        kztLabel: "哈萨克斯坦坚戈 (KZT)",
        commissionLabel: "当前佣金率：",
        purchasePlaceholder: "输入采购价",
        shippingPlaceholder: "阿拉木图运费",
        grossProfitPlaceholder: "输入计划毛利",
        cashbackPlaceholder: "输入下单返利",
        weightPlaceholder: "输入重量",
        lengthPlaceholder: "长",
        widthPlaceholder: "宽",
        heightPlaceholder: "高",
        exchangePlaceholder: "输入汇率",
        categorySearchPlaceholder: "搜索分类...",
        overseasUnitLabel: "海外仓单价 (¥/m³)",
        firstmileUnitLabel: "头程单价 (¥/m³)",
        kaspiPriceCnyLabel: "人民币 (¥)",
        kaspiPriceKztLabel: "坚戈 (₸)",
        // 新增开关标签
        overseasToggleLabel: "是否计算海外仓费用",
        firstmileToggleLabel: "是否计算头程费用",
        withdrawalFeeToggleLabel: "是否计算提现手续费",
        exchangeLossToggleLabel: "是否计算汇损",
        remittanceFeeToggleLabel: "是否计算汇款手续费",
        // 新增历史记录相关翻译
        historyTitle: "历史记录",
        exportBtn: "导出为CSV",
        clearBtn: "清空历史",
        deleteBtn: "删除",
        // 新增历史记录表头翻译
        historyTableHeaders: [
            "商品分类", "采购价", "运费", "计划毛利", "下单返利(%)", "汇款方式",
            "尺寸(长宽高)", "体积", "重量", "海外仓费用", "头程费用", "下单返利",
            "Kaspi运费", "平台佣金", "提现税", "提现手续费", "汇损", "汇款手续费",
            "Kaspi提现", "回款金额", "预估到账", "利润", "币种", "操作"
        ],
        contactLabel: "业务咨询：",
        contactLinkText: "点击联系客服",
        // 免责声明翻译
        disclaimerTitle: "免责声明",
        disclaimerText1: "以上计算结果仅供参考，不代表最终费用。实际费用可能因市场变化、汇率波动、平台政策调整等因素而有所不同，请以实际情况为准。",
        disclaimerText2: "本计算器提供的数据仅作为商业决策的参考依据，不构成任何形式的承诺或保证。使用本工具产生的任何商业风险由使用者自行承担。",
        // 广告标题
        adTitle: "增值服务",
        // 倒计时文本
        countdownText: "服务截止: "
    },
    ru: {
        companyName: "Синьцзянская Международная Логистическая Компания Хан Мао Тун",
        appTitle: "Калькулятор прибыли Kaspi",
        exchangeLabel: "Текущий курс: 1 юань = ",
        currencyLabel: "казахстанских тенге",
        productInfo: "Информация о продукте",
        categoryLabel: "Категория товара",
        purchaseLabel: "Закупочная цена (₸)",
        shippingLabel: "Стоимость доставки (₸)",
        grossProfitLabel: "Плановая валовая прибыль (₸)",
        cashbackLabel: "Кэшбэк за заказ (%)",
        paymentLabel: "Способ оплаты",
        logisticsTitle: "Логистическая информация",
        dimensionLabel: "Размеры (см)",
        volumeLabel: "Объем (м³)",
        weightLabel: "Вес (кг)",
        kaspiPriceLabel: "Цена на Kaspi",
        feesTitle: "Расходы на доставку и склад",
        overseasLabel: "Стоимость зарубежного склада (₸)",
        firstmileLabel: "Стоимость первой мили (₸)",
        platformTitle: "Платежи платформы",
        cashbackAmountLabel: "Сумма кэшбэка (₸)",
        kaspiShippingLabel: "Доставка Kaspi (₸)",
        platformFeeLabel: "Комиссия платформы (₸)",
        withdrawalTaxLabel: "Налог на вывод (4%) (₸)",
        returnTitle: "Расходы на возврат средств",
        withdrawalFeeLabel: "Комиссия за вывод (1%) (₸)",
        exchangeLossLabel: "Потери при обмене (1.42%) (₸)",
        remittanceFeeLabel: "Комиссия за перевод (₸)",
        returnAmountLabel: "Сумма возврата (₸)",
        kaspiPayLabel: "Сумма вывода Kaspi pay (₸)",
        estimatedAmountLabel: "Ожидаемая сумма к получению (₸)",
        profitLabelFinal: "Прибыль (₸)",
        copyright: "© 2023 Синьцзянская Международная Логистическая Компания Хан Мао Тун | Калькулятор прибыли Kaspi",
        calculateBtn: "Рассчитать прибыль",
        cnyLabel: "Юань (CNY)",
        kztLabel: "Тенге (KZT)",
        commissionLabel: "Текущая комиссия: ",
        purchasePlaceholder: "Введите закупочную цену",
        shippingPlaceholder: "Стоимость доставки в Алматы",
        grossProfitPlaceholder: "Введите плановую валовую прибыль",
        cashbackPlaceholder: "Введите кэшбэк за заказ",
        weightPlaceholder: "Введите вес",
        lengthPlaceholder: "Длина",
        widthPlaceholder: "Ширина",
        heightPlaceholder: "Высота",
        exchangePlaceholder: "Введите курс обмена",
        categorySearchPlaceholder: "Поиск категории...",
        overseasUnitLabel: "Цена зарубежного склада (₸/м³)",
        firstmileUnitLabel: "Цена первой мили (₸/м³)",
        kaspiPriceCnyLabel: "Юань (¥)",
        kaspiPriceKztLabel: "Тенге (₸)",
        // 新增开关标签
        overseasToggleLabel: "Расчет стоимости зарубежного склада",
        firstmileToggleLabel: "Расчет стоимости первой мили",
        withdrawalFeeToggleLabel: "Расчет комиссии за вывод",
        exchangeLossToggleLabel: "Расчет потерь при обмене",
        remittanceFeeToggleLabel: "Расчет комиссии за перевод",
        // 新增历史记录相关翻译
        historyTitle: "История расчетов",
        exportBtn: "Экспорт в CSV",
        clearBtn: "Очистить историю",
        deleteBtn: "Удалить",
        // 新增历史记录表头翻译
        historyTableHeaders: [
            "Категория", "Закупочная цена", "Стоимость доставки", "Плановая валовая прибыль", "Кэшбэк за заказ(%)", "Способ оплаты",
            "Размеры(Д×Ш×В)", "Объем", "Вес", "Стоимость зарубежного склада", "Стоимость первой мили", "Кэшбэк",
            "Доставка Kaspi", "Комиссия платформы", "Налог на вывод", "Комиссия за вывод", "Потери при обмене", "Комиссия за перевод",
            "Вывод Kaspi", "Сумма возврата", "Ожидаемая сумма", "Прибыль", "Валюта", "Действие"
        ],
        contactLabel: "Бизнес-консультации:",
        contactLinkText: "Нажмите, чтобы связаться",
        // 免责声明翻译
        disclaimerTitle: "Отказ от ответственности",
        disclaimerText1: "Приведенные выше результаты расчетов приведены только для справки и не являются окончательной стоимостью. Фактические расходы могут различаться из-за изменения рыночных условий, колебаний обменного курса, корректировок политики платформы и других факторов. Пожалуйста, основывайтесь на фактической ситуации.",
        disclaimerText2: "Данные, предоставляемые данным калькулятором, предназначены только для справки при принятии коммерческих решений и не являются каким-либо обязательством или гарантией. Любые коммерческие риски, возникающие при использовании данного инструмента, несет пользователь.",
        // 广告标题
        adTitle: "Дополнительные услуги",
        // 倒计时文本
        countdownText: "Срок действия: "
    }
};

// categories.js
const categories = [
    { id: "auto-cards", name: { zh: "汽车名片", ru: "Автомобильные визитки" }, commission: 0.12 },
    { id: "watch-straps", name: { zh: "手表带", ru: "Ювелирные ремешки и браслеты для часов" }, commission: 0.15 }
];

// main.js
document.addEventListener('DOMContentLoaded', function () {
    // 初始化变量
    let currentLanguage = 'zh';
    let currentCurrency = 'cny';
    let currentCommission = 0.12; // 默认佣金率
    let expiryDate = 0;
    let countdownInterval = null;

    // 新增历史记录数组
    let historyRecords = [];

    // 获取DOM元素
    const exchangeRate = document.getElementById('exchangeRate');
    const purchasePrice = document.getElementById('purchasePrice');
    const shippingCost = document.getElementById('shippingCost');
    const grossProfit = document.getElementById('grossProfit'); // 修改为计划毛利
    const cashback = document.getElementById('cashback');
    const paymentMethod = document.getElementById('paymentMethod');
    const length = document.getElementById('length');
    const width = document.getElementById('width');
    const height = document.getElementById('height');
    const volume = document.getElementById('volume');
    const weight = document.getElementById('weight');
    const kaspiPriceCny = document.getElementById('kaspiPriceCny');
    const kaspiPriceKzt = document.getElementById('kaspiPriceKzt');
    const overseasWarehouse = document.getElementById('overseasWarehouse');
    const firstMile = document.getElementById('firstMile');
    const cashbackAmount = document.getElementById('cashbackAmount');
    const kaspiShipping = document.getElementById('kaspiShipping');
    const platformFee = document.getElementById('platformFee');
    const withdrawalTax = document.getElementById('withdrawalTax');
    const withdrawalFee = document.getElementById('withdrawalFee');
    const exchangeLoss = document.getElementById('exchangeLoss');
    const remittanceFee = document.getElementById('remittanceFee');
    const kaspiPayAmount = document.getElementById('kaspiPayAmount');
    const returnAmountDisplay = document.getElementById('returnAmountDisplay');
    const estimatedAmount = document.getElementById('estimatedAmount');
    const profit = document.getElementById('profit');
    const calculateBtn = document.getElementById('calculateBtn');
    const commissionDisplay = document.getElementById('commission-display');
    const container = document.querySelector('.container');
    // 获取新增的DOM元素
    const historyTableBody = document.getElementById('historyTableBody');
    const exportHistoryBtn = document.getElementById('exportHistoryBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');

    // 新增元素
    const overseasUnitPrice = document.getElementById('overseasUnitPrice');
    const firstMileUnitPrice = document.getElementById('firstMileUnitPrice');
    const overseasToggle = document.getElementById('overseasToggle');
    const firstMileToggle = document.getElementById('firstMileToggle');
    const withdrawalFeeToggle = document.getElementById('withdrawalFeeToggle');
    const exchangeLossToggle = document.getElementById('exchangeLossToggle');
    const remittanceFeeToggle = document.getElementById('remittanceFeeToggle');

    // 错误消息元素
    const exchangeError = document.getElementById('exchange-error');
    const purchaseError = document.getElementById('purchase-error');
    const shippingError = document.getElementById('shipping-error');
    const profitError = document.getElementById('profit-error');
    const weightError = document.getElementById('weight-error');

    // 分类选择器
    const categorySelect = document.getElementById('category-select');
    const categorySearch = document.getElementById('category-search');
    const searchResults = document.getElementById('search-results');

    // 货币选择器
    const currencyCny = document.getElementById('currency-cny');
    const currencyKzt = document.getElementById('currency-kzt');

    // 开关标签元素
    const overseasToggleLabel = document.getElementById('overseas-toggle-label');
    const firstmileToggleLabel = document.getElementById('firstmile-toggle-label');
    const withdrawalFeeToggleLabel = document.getElementById('withdrawal-fee-toggle-label');
    const exchangeLossToggleLabel = document.getElementById('exchange-loss-toggle-label');
    const remittanceFeeToggleLabel = document.getElementById('remittance-fee-toggle-label');

    // 倒计时元素
    const countdownElement = document.getElementById('countdown-text');
    const countdownContainer = document.getElementById('countdown');

    // 扁平化分类数据用于搜索
    let flatCategories = [];

    function flattenCategories(categories, level = 1, parentPath = "") {
        categories.forEach(cat => {
            const path = parentPath ? `${parentPath} > ${cat.name.zh}` : cat.name.zh;
            flatCategories.push({
                id: cat.id,
                name: cat.name,
                commission: cat.commission,
                level: level,
                path: path
            });
        });
        
    }

    flattenCategories(categories);

    // 初始化分类选择器
    function populateCategorySelect(selectElement, categories, placeholder) {
        // 保存当前选中的值
        const selectedValue = selectElement.value;

        selectElement.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = placeholder;
        defaultOption.dataset.commission = '';
        selectElement.appendChild(defaultOption);

        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name[currentLanguage];
            option.dataset.commission = cat.commission;
            selectElement.appendChild(option);
        });

        // 恢复选中的值
        if (selectedValue) {
            selectElement.value = selectedValue;
        }
    }

    // 填充商品分类
    populateCategorySelect(categorySelect, categories, currentLanguage === 'zh' ? '-- 请选择商品分类 --' : '-- Выберите категорию товара --');

    // 分类选择变化事件
    categorySelect.addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];
        currentCommission = parseFloat(selectedOption.dataset.commission) || 0.12;

        // 更新佣金显示
        const trans = translations[currentLanguage];
        commissionDisplay.textContent = trans.commissionLabel + (currentCommission * 100).toFixed(0) + '%';

        // 重新计算
        calculateAll();
    });

    // 分类搜索功能
    categorySearch.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        if (!searchTerm) {
            searchResults.style.display = 'none';
            return;
        }

        const results = flatCategories.filter(cat =>
            cat.name.zh.toLowerCase().includes(searchTerm) ||
            cat.name.ru.toLowerCase().includes(searchTerm)
        );

        if (results.length === 0) {
            searchResults.style.display = 'none';
            return;
        }

        searchResults.innerHTML = '';
        results.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'search-result-item';
            div.textContent = currentLanguage === 'zh' ? cat.path : cat.name.ru;
            div.dataset.id = cat.id;
            div.dataset.commission = cat.commission;
            div.dataset.level = cat.level;
            searchResults.appendChild(div);
        });

        searchResults.style.display = 'block';
    });

    // 处理搜索结果选择
    searchResults.addEventListener('click', function (e) {
        if (e.target.classList.contains('search-result-item')) {
            const catId = e.target.dataset.id;
            const commission = e.target.dataset.commission;

            // 设置佣金率
            currentCommission = parseFloat(commission) || 0.12;

            // 更新佣金显示
            const trans = translations[currentLanguage];
            commissionDisplay.textContent = trans.commissionLabel + (currentCommission * 100).toFixed(0) + '%';

            // 查找并设置分类
            const foundCategory = flatCategories.find(cat => cat.id === catId);
            if (foundCategory) {
                categorySelect.value = catId;
            }

            categorySearch.value = '';
            searchResults.style.display = 'none';

            // 重新计算
            calculateAll();
        }
    });

    // 点击搜索图标聚焦搜索框
    document.querySelector('.search-icon').addEventListener('click', function () {
        categorySearch.focus();
    });

    // 语言切换功能
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const oldLanguage = currentLanguage;
            currentLanguage = this.dataset.lang;

            // 更新按钮状态
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // 更新body类名
            document.body.className = '';
            document.body.classList.add(`lang-${currentLanguage}`);

            // 更新页面文本
            updateLanguage();

            // 转换货币值
            const rate = parseFloat(exchangeRate.value) || 70;

            // 需要转换的字段
            const fieldsToConvert = [
                purchasePrice,
                shippingCost,
                grossProfit, // 新增计划毛利的转换
                overseasUnitPrice,
                firstMileUnitPrice
            ];

            fieldsToConvert.forEach(field => {
                const value = parseFloat(field.value);
                if (!isNaN(value)) {
                    if (oldLanguage === 'zh' && currentLanguage === 'ru') {
                        // 人民币 → 坚戈
                        field.value = (value * rate).toFixed(2);
                    } else if (oldLanguage === 'ru' && currentLanguage === 'zh') {
                        // 坚戈 → 人民币
                        field.value = (value / rate).toFixed(2);
                    }
                }
            });

            // 初始化新语言的默认单价
            initializeDefaultPrices();

            // 更新支付方式选项
            if (currentLanguage === 'ru') {
                paymentMethod.innerHTML = '<option value="kaspi">Kaspi.kz</option>';
                currencyKzt.checked = true;
                currentCurrency = 'kzt';
            } else {
                // 恢复中文支付方式选项
                paymentMethod.innerHTML = `
                    <option value="publicToPublic">银行公对公</option>
                    <option value="publicToPrivate">银行公对私</option>
                    <option value="privateToPrivate">银行私对私</option>
                    <option value="wechat">微信</option>
                    <option value="alipay">支付宝</option>
                    <option value="kaspi">Kaspi.kz</option>
                `;
                currencyCny.checked = true;
                currentCurrency = 'cny';
            }

            // 重新计算
            calculateAll();
        });
    });

    // 货币切换功能
    document.querySelectorAll('.currency-radio').forEach(radio => {
        radio.addEventListener('change', function () {
            currentCurrency = this.value;
            calculateAll(); // 重新计算并显示结果
        });
    });

    // 更新页面语言
    function updateLanguage() {
        const trans = translations[currentLanguage];

        // 更新文本内容
        document.getElementById('company-name').textContent = trans.companyName;
        document.getElementById('app-title').textContent = trans.appTitle;
        document.getElementById('exchange-label').textContent = trans.exchangeLabel;
        document.getElementById('currency-label').textContent = trans.currencyLabel;
        document.getElementById('product-info-title').textContent = trans.productInfo;
        document.getElementById('category-label').textContent = trans.categoryLabel;
        document.getElementById('purchase-label').textContent = trans.purchaseLabel;
        document.getElementById('shipping-label').textContent = trans.shippingLabel;
        document.getElementById('gross-profit-label').textContent = trans.grossProfitLabel; // 修改为计划毛利
        document.getElementById('cashback-label').textContent = trans.cashbackLabel;
        document.getElementById('payment-label').textContent = trans.paymentLabel;
        document.getElementById('logistics-title').textContent = trans.logisticsTitle;
        document.getElementById('dimension-label').textContent = trans.dimensionLabel;
        document.getElementById('volume-label').textContent = trans.volumeLabel;
        document.getElementById('weight-label').textContent = trans.weightLabel;
        document.getElementById('kaspi-price-label').textContent = trans.kaspiPriceLabel;
        document.getElementById('fees-title').textContent = trans.feesTitle;
        document.getElementById('overseas-label').textContent = trans.overseasLabel;
        document.getElementById('firstmile-label').textContent = trans.firstmileLabel;
        document.getElementById('platform-title').textContent = trans.platformTitle;
        document.getElementById('cashback-amount-label').textContent = trans.cashbackAmountLabel;
        document.getElementById('kaspi-shipping-label').textContent = trans.kaspiShippingLabel;
        document.getElementById('platform-fee-label').textContent = trans.platformFeeLabel;
        document.getElementById('withdrawal-tax-label').textContent = trans.withdrawalTaxLabel;
        document.getElementById('return-title').textContent = trans.returnTitle;
        document.getElementById('withdrawal-fee-label').textContent = trans.withdrawalFeeLabel;
        document.getElementById('exchange-loss-label').textContent = trans.exchangeLossLabel;
        document.getElementById('remittance-fee-label').textContent = trans.remittanceFeeLabel;
        document.getElementById('return-amount-label').textContent = trans.returnAmountLabel;
        document.getElementById('kaspi-pay-label').textContent = trans.kaspiPayLabel;
        document.getElementById('estimated-amount-label').textContent = trans.estimatedAmountLabel;
        document.getElementById('profit-label-final').textContent = trans.profitLabelFinal;
        document.getElementById('copyright').textContent = trans.copyright;
        document.getElementById('cny-label').textContent = trans.cnyLabel;
        document.getElementById('kzt-label').textContent = trans.kztLabel;

        document.getElementById('kaspi-price-cny-label').textContent = trans.kaspiPriceCnyLabel;
        document.getElementById('kaspi-price-kzt-label').textContent = trans.kaspiPriceKztLabel;
        document.getElementById('overseas-unit-label').textContent = trans.overseasUnitLabel;
        document.getElementById('firstmile-unit-label').textContent = trans.firstmileUnitLabel;

        // 更新按钮文本
        calculateBtn.textContent = trans.calculateBtn;

        // 更新占位符文本
        categorySearch.placeholder = trans.categorySearchPlaceholder;
        purchasePrice.placeholder = trans.purchasePlaceholder;
        shippingCost.placeholder = trans.shippingPlaceholder;
        grossProfit.placeholder = trans.grossProfitPlaceholder; // 修改为计划毛利
        cashback.placeholder = trans.cashbackPlaceholder;
        weight.placeholder = trans.weightPlaceholder;
        length.placeholder = trans.lengthPlaceholder;
        width.placeholder = trans.widthPlaceholder;
        height.placeholder = trans.heightPlaceholder;
        exchangeRate.placeholder = trans.exchangePlaceholder;

        // 更新开关标签文本
        overseasToggleLabel.textContent = trans.overseasToggleLabel;
        firstmileToggleLabel.textContent = trans.firstmileToggleLabel;
        withdrawalFeeToggleLabel.textContent = trans.withdrawalFeeToggleLabel;
        exchangeLossToggleLabel.textContent = trans.exchangeLossToggleLabel;
        remittanceFeeToggleLabel.textContent = trans.remittanceFeeToggleLabel;

        // 更新分类选择框
        populateCategorySelect(categorySelect, categories, currentLanguage === 'zh' ? '-- 请选择商品分类 --' : '-- Выберите категорию товара --');

        // 更新佣金显示
        commissionDisplay.textContent = trans.commissionLabel + (currentCommission * 100).toFixed(0) + '%';
        
        // 更新历史记录区域文本
        document.getElementById('history-title').textContent = trans.historyTitle;
        exportHistoryBtn.textContent = trans.exportBtn;
        clearHistoryBtn.textContent = trans.clearBtn;
        
        // 重新渲染历史记录表格
        renderHistoryTable();
        
        // 更新联系文本
        updateContactText();
        
        // 更新广告标题
        document.getElementById('ad-title').textContent = trans.adTitle;
        
        // 更新免责声明
        document.getElementById('disclaimer-title').textContent = trans.disclaimerTitle;
        document.getElementById('disclaimer-content').innerHTML = 
            `<p>${trans.disclaimerText1}</p><p>${trans.disclaimerText2}</p>`;
        
        // 更新倒计时文本前缀
        document.getElementById('countdown-text').textContent = trans.countdownText + formatTime(expiryDate - Date.now());
    }
    
    // 更新联系文本的函数
    function updateContactText() {
        const trans = translations[currentLanguage];
        const contactSpan = document.querySelector('.contact-info span');
        if (contactSpan) {
            contactSpan.textContent = trans.contactLabel || "业务咨询：";
        }
        const contactLinkElem = document.getElementById('contact-link');
        if (contactLinkElem) {
            contactLinkElem.textContent = trans.contactLinkText || "点击联系客服";
        }
    }

    // 验证输入
    function validateInputs() {
        let isValid = true;

        // 隐藏所有错误消息
        exchangeError.style.display = 'none';
        purchaseError.style.display = 'none';
        shippingError.style.display = 'none';
        profitError.style.display = 'none';
        weightError.style.display = 'none';

        // 验证汇率
        const rate = parseFloat(exchangeRate.value);
        if (isNaN(rate)) {
            exchangeError.textContent = currentLanguage === 'zh' ? '请输入汇率' : 'Введите курс обмена';
            exchangeError.style.display = 'block';
            isValid = false;
        } else if (rate <= 0) {
            exchangeError.textContent = currentLanguage === 'zh' ? '汇率必须大于0' : 'Курс должен быть больше 0';
            exchangeError.style.display = 'block';
            isValid = false;
        }

        // 验证采购价
        const purchase = parseFloat(purchasePrice.value);
        if (isNaN(purchase) || purchase < 0) {
            purchaseError.textContent = currentLanguage === 'zh' ? '请输入有效的采购价' : 'Введите действительную закупочную цену';
            purchaseError.style.display = 'block';
            isValid = false;
        }

        // 验证运费
        const shipping = parseFloat(shippingCost.value);
        if (isNaN(shipping) || shipping < 0) {
            shippingError.textContent = currentLanguage === 'zh' ? '请输入有效的运费' : 'Введите действительную стоимость доставки';
            shippingError.style.display = 'block';
            isValid = false;
        }

        // 验证计划毛利
        const profitInput = parseFloat(grossProfit.value);
        if (isNaN(profitInput) || profitInput < 0) {
            profitError.textContent = currentLanguage === 'zh' ? '请输入有效的计划毛利' : 'Введите действительную плановую валовую прибыль';
            profitError.style.display = 'block';
            isValid = false;
        }

        // 验证重量
        const w = parseFloat(weight.value);
        if (isNaN(w) || w <= 0) {
            weightError.textContent = currentLanguage === 'zh' ? '请输入有效的重量' : 'Введите действительный вес';
            weightError.style.display = 'block';
            isValid = false;
        }

        return isValid;
    }

    // 计算体积
    function calculateVolume() {
        const l = parseFloat(length.value) || 0;
        const w = parseFloat(width.value) || 0;
        const h = parseFloat(height.value) || 0;

        if (l > 0 && w > 0 && h > 0) {
            const vol = (l / 100) * (w / 100) * (h / 100);
            volume.value = vol.toFixed(4) + ' m³';
            return vol;
        }

        volume.value = '';
        return 0;
    }

    // 初始化默认单价
    function initializeDefaultPrices() {
        const rate = parseFloat(exchangeRate.value) || 70;

        // 检查用户是否手动修改过值
        const overseasUserSet = overseasUnitPrice.dataset.userSet === 'true';
        const firstMileUserSet = firstMileUnitPrice.dataset.userSet === 'true';

        // 中文界面：显示坚戈值除以汇率（人民币值）
        if (currentLanguage === 'zh') {
            if (!overseasUserSet) {
                overseasUnitPrice.value = (1000 / rate).toFixed(2);
            }
            if (!firstMileUserSet) {
                firstMileUnitPrice.value = (100 / rate).toFixed(2);
            }
        }
        // 俄语界面：直接显示坚戈值
        else {
            if (!overseasUserSet) {
                overseasUnitPrice.value = "1000";
            }
            if (!firstMileUserSet) {
                firstMileUnitPrice.value = "100";
            }
        }
    }

    // 计算所有费用并显示结果
    function calculateAll() {
        // 验证输入
        if (!validateInputs()) {
            return;
        }

        // 获取输入值
        const rate = parseFloat(exchangeRate.value);
        const purchase = parseFloat(purchasePrice.value) || 0;
        const shipping = parseFloat(shippingCost.value) || 0;
        const grossProfitInput = parseFloat(grossProfit.value) || 0; // 计划毛利
        const cb = parseFloat(cashback.value) || 0;
        const w = parseFloat(weight.value) || 0;
        const vol = calculateVolume();
        const cat = currentCommission;

        // 获取费用单价（根据语言转换为人民币）
        let overseasUnit, firstMileUnit;
        if (currentLanguage === 'zh') {
            // 中文界面：用户输入的是人民币
            overseasUnit = parseFloat(overseasUnitPrice.value) || 0;
            firstMileUnit = parseFloat(firstMileUnitPrice.value) || 0;
        } else {
            // 俄语界面：用户输入的是坚戈，转换为人民币
            overseasUnit = (parseFloat(overseasUnitPrice.value) || 0) / rate;
            firstMileUnit = (parseFloat(firstMileUnitPrice.value) || 0) / rate;
        }

        // 计算Kaspi售价（人民币） - 使用计划毛利
        let kaspiPriceCnyValue;
        if (currentLanguage === 'ru') {
            // 俄语界面：采购价和运费是坚戈，计划毛利也是坚戈
            kaspiPriceCnyValue = (purchase + shipping + grossProfitInput) / rate;
        } else {
            // 中文界面：采购价和运费是人民币，计划毛利也是人民币
            kaspiPriceCnyValue = purchase + shipping + grossProfitInput;
        }

        // 计算Kaspi售价（坚戈）
        const kaspiPriceKztValue = kaspiPriceCnyValue * rate;

        // 更新双列Kaspi售价显示
        kaspiPriceCny.value = kaspiPriceCnyValue.toFixed(2) + '¥';
        kaspiPriceKzt.value = kaspiPriceKztValue.toFixed(2) + '₸';

        // 海外仓费用计算
        let overseasValue = 0;
        if (overseasToggle.checked && vol > 0) {
            if (vol <= 1) {
                overseasValue = overseasUnit;
            } else {
                overseasValue = Math.ceil(vol) * overseasUnit;
            }
        }

        // 头程费用计算
        let firstMileValue = 0;
        if (firstMileToggle.checked && vol > 0) {
            if (vol <= 0.01) {
                firstMileValue = firstMileUnit;
            } else {
                firstMileValue = vol * 100 * firstMileUnit;
            }
        }

        // 4. 计算下单返利（人民币）
        const cashbackValue = (cb / 100 * kaspiPriceKztValue) / rate;

        // 5. 计算Kaspi运费（人民币）
        let kaspiShippingValue = 0;
        if (kaspiPriceKztValue > 0) {
            if (kaspiPriceKztValue < 5000) {
                kaspiShippingValue = 0;
            } else if (kaspiPriceKztValue <= 15000) {
                kaspiShippingValue = 799 / rate;
            } else {
                if (w < 5) {
                    kaspiShippingValue = 1299 / rate;
                } else if (w <= 15) {
                    kaspiShippingValue = 1699 / rate;
                } else if (w <= 50) {
                    kaspiShippingValue = 3599 / rate;
                } else {
                    kaspiShippingValue = 6499 / rate;
                }
            }
        }

        // 6. 计算平台佣金（人民币）
        const platformFeeValue = (kaspiPriceKztValue * cat) / rate;

        // 7. 计算提现税（4%）（人民币）
        const baseAmount = kaspiPriceKztValue / rate;
        const withdrawalTaxValue = (baseAmount - cashbackValue - kaspiShippingValue - platformFeeValue) * 0.04;

        // 8. 计算Kaspi pay提现到账金额（人民币）
        const kaspiPayAmountValue = baseAmount - cashbackValue - kaspiShippingValue - platformFeeValue - withdrawalTaxValue;

        // 9. 计算提现手续费（1%）（人民币） - 考虑开关状态
        let withdrawalFeeValue = 0;
        if (withdrawalFeeToggle.checked) {
            withdrawalFeeValue = kaspiPayAmountValue * 0.01;
        }

        // 10. 计算回款金额（人民币）
        const returnAmountValue = kaspiPayAmountValue - withdrawalFeeValue - overseasValue - firstMileValue;

        // 11. 计算汇损（1.42%）（人民币） - 考虑开关状态
        let exchangeLossValue = 0;
        if (exchangeLossToggle.checked) {
            exchangeLossValue = returnAmountValue * 0.0142;
        }

        // 12. 计算汇款手续费（人民币） - 考虑开关状态
        let remittanceFeeValue = 0;
        if (remittanceFeeToggle.checked && returnAmountValue > 0) {
            const method = paymentMethod.value;
            switch (method) {
                case 'publicToPublic':
                    if (returnAmountValue <= 10000) {
                        remittanceFeeValue = 5;
                    } else if (returnAmountValue <= 100000) {
                        remittanceFeeValue = 10;
                    } else if (returnAmountValue <= 500000) {
                        remittanceFeeValue = 15;
                    } else if (returnAmountValue <= 1000000) {
                        remittanceFeeValue = 20;
                    } else {
                        remittanceFeeValue = Math.min(200, Math.ceil(returnAmountValue * 0.00002 * 100) / 100);
                    }
                    break;
                case 'publicToPrivate':
                    if (returnAmountValue <= 10000) {
                        remittanceFeeValue = 5;
                    } else if (returnAmountValue <= 100000) {
                        remittanceFeeValue = 10;
                    } else if (returnAmountValue <= 500000) {
                        remittanceFeeValue = 15;
                    } else if (returnAmountValue <= 1000000) {
                        remittanceFeeValue = 20;
                    } else {
                        remittanceFeeValue = Math.min(200, Math.ceil(returnAmountValue * 0.00002 * 100) / 100);
                    }
                    break;
                case 'privateToPrivate':
                    if (returnAmountValue <= 5000) {
                        remittanceFeeValue = 0;
                    } else if (returnAmountValue <= 10000) {
                        remittanceFeeValue = 5;
                    } else if (returnAmountValue <= 50000) {
                        remittanceFeeValue = 7.5;
                    } else {
                        remittanceFeeValue = Math.min(25, Math.ceil(returnAmountValue * 0.00015 * 100) / 100);
                    }
                    break;
                case 'wechat':
                    remittanceFeeValue = Math.max(0.1, Math.ceil(returnAmountValue * 0.001 * 100) / 100);
                    break;
                case 'alipay':
                    remittanceFeeValue = Math.max(0.1, Math.ceil(returnAmountValue * 0.001 * 100) / 100);
                    break;
                case 'kaspi':
                    remittanceFeeValue = 0;
                    break;
                default:
                    remittanceFeeValue = 0;
            }
        }

        // 13. 计算预估到账金额（人民币）
        const estimatedAmountValue = returnAmountValue - exchangeLossValue - remittanceFeeValue;

        // 14. 计算利润
        let profitValue;
        if (currentLanguage === 'ru') {
            // 俄语界面:输入值是坚戈,需要转换为人民币
            const purchaseInCNY = purchase / rate;
            const shippingInCNY = shipping / rate;
            const grossProfitInCNY = grossProfitInput / rate;
            profitValue = estimatedAmountValue - purchaseInCNY - shippingInCNY;
        } else {
            // 中文界面:输入值已经是人民币
            profitValue = estimatedAmountValue - purchase - shipping;
        }

        // 显示结果时的货币转换
        const currencyRate = currentCurrency === 'kzt' ? rate : 1;
        const currencySymbol = currentCurrency === 'kzt' ? '₸' : '¥';

        // 更新显示结果
        overseasWarehouse.value = (overseasValue * currencyRate).toFixed(2) + currencySymbol;
        firstMile.value = (firstMileValue * currencyRate).toFixed(2) + currencySymbol;
        cashbackAmount.value = (cashbackValue * currencyRate).toFixed(2) + currencySymbol;
        kaspiShipping.value = (kaspiShippingValue * currencyRate).toFixed(2) + currencySymbol;
        platformFee.value = (platformFeeValue * currencyRate).toFixed(2) + currencySymbol;
        withdrawalTax.value = (withdrawalTaxValue * currencyRate).toFixed(2) + currencySymbol;
        withdrawalFee.value = (withdrawalFeeValue * currencyRate).toFixed(2) + currencySymbol;
        exchangeLoss.value = (exchangeLossValue * currencyRate).toFixed(2) + currencySymbol;
        remittanceFee.value = (remittanceFeeValue * currencyRate).toFixed(2) + currencySymbol;
        kaspiPayAmount.textContent = (kaspiPayAmountValue * currencyRate).toFixed(2) + currencySymbol;
        returnAmountDisplay.textContent = (returnAmountValue * currencyRate).toFixed(2) + currencySymbol;
        estimatedAmount.textContent = (estimatedAmountValue * currencyRate).toFixed(2) + currencySymbol;
        profit.textContent = (profitValue * currencyRate).toFixed(2) + currencySymbol;

        // 根据利润值设置颜色
        if (profitValue > 0) {
            profit.style.color = '#27ae60';
        } else if (profitValue < 0) {
            profit.style.color = '#c0392b';
        } else {
            profit.style.color = '#e65100';
        }

        // 更新开关标签状态
        updateToggleLabels();

        // 在计算完成后，添加历史记录
        addHistoryRecord();
    }

    // 添加历史记录函数
    function addHistoryRecord() {
        // 收集所有需要记录的数据
        const trans = translations[currentLanguage];
        const record = {
            timestamp: new Date().toLocaleString(),
            category: categorySelect.options[categorySelect.selectedIndex].text,
            purchasePrice: purchasePrice.value,
            shippingCost: shippingCost.value,
            grossProfit: grossProfit.value,
            cashback: cashback.value,
            paymentMethod: paymentMethod.options[paymentMethod.selectedIndex].text,
            dimensions: `${length.value || 0}×${width.value || 0}×${height.value || 0}`,
            volume: volume.value,
            weight: weight.value,
            overseasWarehouse: overseasWarehouse.value,
            firstMile: firstMile.value,
            cashbackAmount: cashbackAmount.value,
            kaspiShipping: kaspiShipping.value,
            platformFee: platformFee.value,
            withdrawalTax: withdrawalTax.value,
            withdrawalFee: withdrawalFee.value,
            exchangeLoss: exchangeLoss.value,
            remittanceFee: remittanceFee.value,
            kaspiPayAmount: kaspiPayAmount.textContent,
            returnAmount: returnAmountDisplay.textContent,
            estimatedAmount: estimatedAmount.textContent,
            profit: profit.textContent,
            currency: currentCurrency === 'cny' ? trans.cnyLabel : trans.kztLabel
        };
        
        // 添加到历史记录数组
        historyRecords.push(record);
        
        // 渲染表格
        renderHistoryTable();
    }
    
    // 渲染历史记录表格
    function renderHistoryTable() {
        const trans = translations[currentLanguage];
        historyTableBody.innerHTML = '';
        
        // 更新表头翻译
        const headerRow = document.querySelector('#historyTable thead tr');
        if (headerRow) {
            headerRow.innerHTML = '';
            trans.historyTableHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
        }
        
        historyRecords.forEach((record, index) => {
            const row = document.createElement('tr');
            
            // 添加数据单元格
            row.innerHTML = `
                <td>${record.category}</td>
                <td>${record.purchasePrice}</td>
                <td>${record.shippingCost}</td>
                <td>${record.grossProfit}</td>
                <td>${record.cashback}</td>
                <td>${record.paymentMethod}</td>
                <td>${record.dimensions}</td>
                <td>${record.volume}</td>
                <td>${record.weight}</td>
                <td>${record.overseasWarehouse}</td>
                <td>${record.firstMile}</td>
                <td>${record.cashbackAmount}</td>
                <td>${record.kaspiShipping}</td>
                <td>${record.platformFee}</td>
                <td>${record.withdrawalTax}</td>
                <td>${record.withdrawalFee}</td>
                <td>${record.exchangeLoss}</td>
                <td>${record.remittanceFee}</td>
                <td>${record.kaspiPayAmount}</td>
                <td>${record.returnAmount}</td>
                <td>${record.estimatedAmount}</td>
                <td>${record.profit}</td>
                <td>${record.currency}</td>
                <td><button class="delete-btn" data-index="${index}">${trans.deleteBtn || '删除'}</button></td>
            `;
            
            historyTableBody.appendChild(row);
        });
        
        // 添加删除按钮事件监听
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                deleteHistoryRecord(index);
            });
        });
    }
    
    // 删除历史记录
    function deleteHistoryRecord(index) {
        historyRecords.splice(index, 1);
        renderHistoryTable();
    }
    
    // 导出历史记录为CSV
    function exportHistoryToCSV() {
        const trans = translations[currentLanguage];
        if (historyRecords.length === 0) {
            alert(trans.historyTitle + ' ' + (currentLanguage === 'zh' ? '为空' : 'пуста'));
            return;
        }
        
        // 创建CSV标题行
        let csvContent = trans.historyTableHeaders.join(',') + '\n';
        
        // 添加数据行
        historyRecords.forEach(record => {
            const row = [
                record.category,
                record.purchasePrice,
                record.shippingCost,
                record.grossProfit,
                record.cashback,
                record.paymentMethod,
                record.dimensions,
                record.volume,
                record.weight,
                record.overseasWarehouse,
                record.firstMile,
                record.cashbackAmount,
                record.kaspiShipping,
                record.platformFee,
                record.withdrawalTax,
                record.withdrawalFee,
                record.exchangeLoss,
                record.remittanceFee,
                record.kaspiPayAmount,
                record.returnAmount,
                record.estimatedAmount,
                record.profit,
                record.currency,
                record.timestamp
            ];
            csvContent += row.map(field => `"${field}"`).join(',') + '\n';
        });
        
        // 创建下载链接
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        
        link.setAttribute('href', url);
        link.setAttribute('download', `kaspi_history_${timestamp}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // 清空历史记录
    function clearHistory() {
        const trans = translations[currentLanguage];
        if (confirm(currentLanguage === 'zh' ? '确定要清空所有历史记录吗？' : 'Вы уверены, что хотите очистить всю историю?')) {
            historyRecords = [];
            renderHistoryTable();
        }
    }
    
    // 添加事件监听器
    exportHistoryBtn.addEventListener('click', exportHistoryToCSV);
    clearHistoryBtn.addEventListener('click', clearHistory);

    // 更新开关标签状态
    function updateToggleLabels() {
        const toggles = [
            { toggle: overseasToggle, label: document.querySelector('#overseas-label') },
            { toggle: firstMileToggle, label: document.querySelector('#firstmile-label') },
            { toggle: withdrawalFeeToggle, label: document.querySelector('#withdrawal-fee-label') },
            { toggle: exchangeLossToggle, label: document.querySelector('#exchange-loss-label') },
            { toggle: remittanceFeeToggle, label: document.querySelector('#remittance-fee-label') }
        ];

        toggles.forEach(item => {
            if (item.toggle.checked) {
                item.label.classList.remove('toggle-off');
            } else {
                item.label.classList.add('toggle-off');
            }
        });
    }

    // 添加事件监听器
    calculateBtn.addEventListener('click', calculateAll);

    // 开关变化时重新计算
    overseasToggle.addEventListener('change', calculateAll);
    firstMileToggle.addEventListener('change', calculateAll);
    withdrawalFeeToggle.addEventListener('change', calculateAll);
    exchangeLossToggle.addEventListener('change', calculateAll);
    remittanceFeeToggle.addEventListener('change', calculateAll);

    // 费用单价变化时重新计算
    overseasUnitPrice.addEventListener('input', function () {
        this.dataset.userSet = 'true';
        calculateAll();
    });
    firstMileUnitPrice.addEventListener('input', function () {
        this.dataset.userSet = 'true';
        calculateAll();
    });

    // 尺寸变化时自动计算体积
    length.addEventListener('input', calculateVolume);
    width.addEventListener('input', calculateVolume);
    height.addEventListener('input', calculateVolume);

    // 输入变化时隐藏错误消息
    exchangeRate.addEventListener('input', function () {
        exchangeError.style.display = 'none';
        // 汇率变化时更新默认单价
        initializeDefaultPrices();
        calculateAll();
    });
    purchasePrice.addEventListener('input', () => purchaseError.style.display = 'none');
    shippingCost.addEventListener('input', () => shippingError.style.display = 'none');
    grossProfit.addEventListener('input', () => profitError.style.display = 'none'); // 计划毛利
    weight.addEventListener('input', () => weightError.style.display = 'none');
    
    // 新增弹窗功能代码
    const modal = document.getElementById('contactModal');
    const contactLink = document.getElementById('contact-link');
    const modalBody = document.getElementById('modalBody');
    const closeBtn = document.querySelector('.close');
    
    // 点击联系链接显示弹窗
    if (contactLink) {
        contactLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (currentLanguage === 'zh') {
                // 中文显示联系方式图片
                modalBody.innerHTML = `
                    <h3>联系我们</h3>
                    <p>业务咨询请通过以下方式联系：</p>
                    <img src="lxfs.jpg" alt="联系方式">
                    <p>扫描二维码或保存图片联系客服</p>
                `;
            } else {
                // 俄语显示WhatsApp号码
                modalBody.innerHTML = `
                    <h3>Свяжитесь с нами</h3>
                    <p>Для консультации по вопросам бизнеса:</p>
                    <div class="whatsapp-contact">
                        <p><strong>WhatsApp:</strong></p>
                        <p class="phone-number">+7 (705) 911-91-43</p>
                    </div>
                    <p>Рабочее время: Пн-Пт, 9:00-18:00</p>
                `;
            }
            
            modal.style.display = 'block';
        });
    }
    
    // 关闭弹窗
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
    }
    
    // 点击弹窗外部关闭
    window.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // 验证服务有效期
    function validateService() {
        // 从localStorage中获取服务信息
        const serviceInfo = JSON.parse(localStorage.getItem('kaspitAuth'));
        
        if (!serviceInfo) {
            // 没有服务信息，跳转
            redirectToAyaCare();
            return false;
        }
        
        // 验证字段是否存在
        if (!serviceInfo.key || !serviceInfo.encrypted || !serviceInfo.deviceId || !serviceInfo.expiryDate) {
            redirectToAyaCare();
            return false;
        }
        
        // 验证有效期
        const currentTime = Date.now();
        expiryDate = parseInt(serviceInfo.expiryDate);
        
        if (currentTime > expiryDate) {
            redirectToAyaCare();
            return false;
        }
        
        // 验证通过，开始倒计时
        startCountdown();
        return true;
    }
    
    // 启动倒计时
    function startCountdown() {
        // 清除已有计时器
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        // 每秒更新倒计时
        countdownInterval = setInterval(function() {
            const currentTime = Date.now();
            const timeLeft = expiryDate - currentTime;
            
            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                redirectToAyaCare();
                return;
            }
            
            // 更新倒计时显示
            countdownElement.textContent = translations[currentLanguage].countdownText + formatTime(timeLeft);
        }, 1000);
        
        // 显示倒计时
        countdownContainer.style.display = 'flex';
    }
    
    // 格式化时间
    function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const days = Math.floor(totalSeconds / (3600 * 24));
        const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        return `${days}天 ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // 跳转到指定网站
    function redirectToAyaCare() {
        window.location.href = 'https://ayacare.github.io/AyaCare/KaspiPricePilot';
    }
    
    // 根据设备语言设置初始语言
    function detectDeviceLanguage() {
        const userLang = navigator.language || navigator.userLanguage;
        
        if (userLang.startsWith('ru') || userLang.startsWith('be') || userLang.startsWith('kk')) {
            return 'ru';
        } else if (userLang.startsWith('zh')) {
            return 'zh';
        }
        
        return 'zh'; // 默认中文
    }

    // 初始化页面
    function initializePage() {
        // 设置初始语言
        currentLanguage = detectDeviceLanguage();
        
        // 验证服务
        if (!validateService()) {
            return;
        }
        
        // 更新语言按钮状态
        document.querySelectorAll('.lang-btn').forEach(btn => {
            if (btn.dataset.lang === currentLanguage) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // 更新body类名
        document.body.className = '';
        document.body.classList.add(`lang-${currentLanguage}`);
        
        updateLanguage();
        initializeDefaultPrices();
        calculateVolume();
        calculateAll();
        updateContactText(); // 初始化联系文本
    }

    // 在DOMContentLoaded事件的最后调用初始化函数
    initializePage();
});
</script>
</body>
</html>
